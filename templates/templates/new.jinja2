﻿{% extends "base.jinja2" %}
{% from "macro.jinja2" import formhead %}

{% block js %}
    <script type="text/javascript" src="/static/js/form.js"></script>
    <script src="/static/js/jquery.maskedinput.min.js"
            type="text/javascript"></script>
    <script src="/static/js/datepicker.js"></script>
    <script src="/static/js/jquery.tablesorter.min.js"
            type="text/javascript"></script>
    <script src="/static/js/sweet-alert.min.js"
            type="text/javascript"></script>
    <script src="/static/js/chosen.jquery.min.js"></script>
    <script src="/static/js/jquery-ui.min.js"></script>
    <script src="/static/js/iris.min.js"></script>
    <script type="text/javascript"
            src="/static/js/templates_script.js"></script>
{% endblock %}
{% block style %}
    <link rel="stylesheet" type="text/CSS"
          href="/static/css/templates_style.css"/>
{% endblock %}

{% block content %}
    <div class="shab_wrap">
        <div class="photo_mob floating">
            <div class="mob preview_mob">
                <div class="inner">
                    <img src="" class="mob_preview">
                </div>
            </div>
            <div class="mob back_mob">
                <div class="inner bind-bg-color">
                    <div class="sub_inner">
                        <div class="inner_block_set">
                            <div class="inner_line">
                                <div class="flip_wrapper">
                                    <div class="flip"></div>
                                </div>
                            </div>
                            <div class="inner_block_wrapper">
                                <div class="inner_block">
                                    <div class="block_head">Контакты</div>
                                    <div class="bind-contacts"></div>
                                </div>
                                <div class="inner_block">
                                    <div class="block_head">Условия</div>
                                    <div class="bind-conditions"></div>
                                </div>
                                <div class="inner_block bind-confirm">
                                    <div class="block_head">Подтверждение
                                        посещения мероприятия
                                    </div>
                                    <div>Для подтверждения посещения
                                        мероприятия пройдите по ссылке: и
                                        заполните анкету.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mob front_mob">
                <div class="text_zag update_to_small addition_to_phone left step_1"
                     style="top: 75px; left: 390px;">
                    <span>Цвет текста</span>
                </div>
                <div class="text_zag update_to_small addition_to_phone left step_2"
                     style="top: 75px; left: 495px;">
                    <span>Текст заголовка</span>
                </div>
                <div class="field_zag update_to_small addition_to_phone right step_1"
                     style="top: 55px; left: 20px;">
                    <span>Изображение логотипа</span>
                </div>
                <div class="field_usl update_to_small addition_to_phone right step_1"
                     style="left: 30px; top: 129px;">
                    <span>Изображение</span>
                </div>
                <div class="field_usl update_to_small addition_to_phone right step_2"
                     style="left: -14px; top: 140px;">
                    <span>Поле "Контакты"</span>
                </div>
                <div class="field_usl2 update_to_small addition_to_phone right step_1"
                     style="left: 30px; top: 180px;">
                    <span>Цвет фона</span>
                </div>
                <div class="field_usl2 update_to_small addition_to_phone right step_2"
                     style="left: -14px; top: 250px;">
                    <span>Поле "Условия"</span>
                </div>
                <div class="pre_inner">
                    <div class="inner bind-bg-color">
                        <div class="inner_head">
                            <div class="image_wrapper bind-logo bind-bg-color"></div>
                            <div class="head_name bind-name bind-head-color"></div>
                            <div class="only_t2 only_t3 head_date bind-head-color">
                                Действителен до:
                                <div class=" date_wrapper bind-date bind-text-color"></div>
                            </div>
                        </div>
                        <div class="inner_strip bind-strip bind-bg-color">
                            <div class="discount_wrapper only_t2">
                                <div class="bind-discount"></div>
                                <span style="opacity: 0.8; font-size: 16px; background-color: transparent;">Скидка</span>
                            </div>
                        </div>
                        <div class="bind-description card_description bind-text-color only_t2 only_t3"></div>
                        <div class="barcode">0123456789</div>
                    </div>
                    <img src="/static/css/img/front_bg.png">
                </div>
            </div>
        </div>
        <div class="right_menu">
            <ul>
                {% if not template %}
                    <li class="type_li menu_li">
                        Тип
                    </li>
                {% endif %}
                <li class="text_li menu_li">Текст</li>
				<li class="design_li menu_li">Дизайн</li>
                <li class="send_li menu_li">Отправка</li>
            </ul>
            <div class="step_form zero"
                 {% if template %}style="position:absolute; top: -1000px"
                 {% endif %}>
                <div class="type_btn first noneselect spec_after">Выберите тип
                    карты
                </div>
                <div class="type_btn type_1_btn">Карта</div>
                <div class="type_btn type_2_btn">Купон</div>
                <div class="type_btn type_3_btn">Приглашение</div>
            </div>
            <div class="step_form first">
                <div class="shab_items">
                    <div class="item">
                       
                        <div class="item">
                            <div>
                                <div class="logo_wrapper">
                                    <div class="image_wrapper bind-logo"></div>
                                </div>
                                <span class="lefted_h3 lefted">Изображение логотипа</span>
                        <span class="lefted">Изображение в формате png, размер
  поля под логотип 160x50px.</span>

                                <div style="clear: both"></div>
                                <div class="load">
                                    <a href="#removeimg"
                                       title="Заменить изображение"
                                       class="send normal">Заменить
                                        изображение</a>
                                    <input type="file" class="logo_input">
                                </div>
                            </div>
                            <div>
                                <div class="inner_strip bind-strip"
                                     style="float: left;">
                                </div>
                                <span class="lefted_h3 lefted">Изображение</span>
                        <span class="lefted strip">Изображение в формате png, размер
  поля под логотип 620x246px.</span>

                                <div style="clear: both"></div>
                                <div class="load">
                                    <a href="javascript:void(0);"
                                       title="Заменить изображение"
                                       class="send normal">
                                        Заменить изображение
                                    </a>
                                    <input type="file" class="strip_input">
                                </div>
                            </div>
                            <div>
                                <div class="color_scheme bg_color"></div>
                                <div class="color_wrapper">
                                    <span class="lefted_h3 lefted">
                                        Цвет фона
                                    </span>
                                    <span class="lefted selecter">
                                        Выберите цвет фона Вашей карты или
                                        задайте его вручную.
                                    </span>
                                    <input type="text" placeholder="000000"
                                           value="{{ template.background_color|default('#3caffc') }}"
                                           class="lefted color-picker"
                                           id="bg_color_input">
                                </div>
                                <div style="clear: both"></div>
                            </div>
                            <div  class="only_t2 only_t3">
                                <div class="color_scheme text_color"></div>
                                <div class="color_wrapper">
                                    <span class="lefted_h3 lefted">
                                        Цвет текста
                                    </span>
                                    <span class="lefted selecter">
                                        Выберите цвет текста Вашей карты
                                        или задайте его вручную.
                                    </span>
                                    <input type="text" placeholder="000000"
                                           class="lefted color-picker"
                                           id="text_color_input"
                                           value="{{ template.text_color|default('#ffffff') }}">
                                </div>
                                <div style="clear: both"></div>
                            </div>
                            <div>
                                <div class="color_scheme head_color"></div>
                                <div class="color_wrapper">
                                    <span class="lefted_h3 lefted">
                                        Цвет заголовка
                                    </span>
                                    <span class="lefted selecter">
                                        Выберите цвет заголовка Вашей карты
                                        или задайте его вручную.
                                    </span>
                                    <input type="text" placeholder="000000"
                                           class="lefted color-picker"
                                           value="{{ template.label_color|default('#ffffff') }}"
                                           id="head_color_input">
                                </div>
                                <div style="clear: both"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="step_form second">
                <div class="shab_items">
					<div class="item">
						 <div>
                            <span class="spec_after">Название бренда</span>
                            <input type="text" placeholder="Название бренда"
                                   id="organizationName"
                                   class="name_company
                                    {% if template %}disactive{% endif %}"
                                   value="{{ template.organizationName }}">
								    <span class="tips">Имя отправителя пуш-уведомления</span>
                        </div>
					</div>
                    <button class="normal no-cursor">Лицевая сторона карты
                    </button>
                    <div class="item">
                        <div>
                            <span class="spec_after">
                              Заголовок карты</span>
                            <input type="text" placeholder="Текст"
                                   id="name_input"
                                   value="{{ template.logo_text }}"
                                   maxlength="20"
                                   class="text_logo
                                    {% if template %}disactive{% endif %}">
                            <span class="tips">
                                Не более 20-ти символов, включая пробелы и
                                знаки препинания
                            </span>
                        </div>
                    </div>
                    <div class="item only_t2">
                        <div>
                            <span class="spec_after">
                                Выберите дату и время окончания
                            </span>
                            <input type="text" id="discount_date_input"
                                   class="date"
                                   value="{{ template.expirationDate|datetime('full') }}">

                            <div style="clear: both;"></div>
                        </div>
                        <div>
                            <span style="padding-top: 15px;">
                                Введите размер скидки
                            </span>
                            <input type="text" id="discount_input"
                                   placeholder="" maxlength="6"
                                   value="{{ template.primary_field }}">
                            <span class="tips">
                                Не более 6-ти символов, включая пробелы и
                                знаки препинания
                            </span>

                            <div style="clear: both;"></div>
                        </div>
                        <div>
                            <span style="padding-top: 15px;">
                                Опишите условия акции
                            </span>
                            <input type="text" id="discount_description_input"
                                   placeholder="Например, Скидка на овощи"
                                   maxlength="40"
                                   value="{{ template.secondary_field }}">
                            <span class="tips">
                                Не более 40-ка символов, включая пробелы и
                                знаки препинания
                            </span>

                            <div style="clear: both;"></div>
                        </div>
                    </div>
                    <div class="item">
                        <div>
                            <span>Выберите тип штрихкода</span>
                            <select placeholder="Выберите тип штрихкода"
                                    class="strich_sel">
                                <option value="PKBarcodeFormatPDF417"
                                        class="pdf"
                                        {% if template.barcode_format == 'PKBarcodeFormatPDF417' %}
                                        selected="selected"{% endif %}>
                                    pdf417
                                </option>
                                <option value="PKBarcodeFormatAztec"
                                        class="aztec"
                                        {% if template.barcode_format == 'PKBarcodeFormatAztec' %}
                                        selected="selected"{% endif %}>Aztec
                                </option>
                                <option value="PKBarcodeFormatQR" class="qr"
                                        {% if template.barcode_format == 'PKBarcodeFormatQR' %}
                                        selected="selected"{% endif %}
                                        >
                                    QR
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="item only_t3">
                        <div>
                            <span class="spec_after">Выберите дату</span>
                            <input type="text" id="event_date_input"
                                   class="date"
                                   value="{{ template.expirationDate|datetime('medium') }}">

                            <div style="clear: both;"></div>
                        </div>
                        <div>
                            <span style="padding-top: 15px;">
                                Укажите описание мероприятия
                            </span>
                            <input type="text" id="event_description_input"
                                   value="{{ template.secondary_field }}"
                                   maxlength="40">
                            <span class="tips">
                                Не более 40-ка символов, включая пробелы и
                                знаки препинания
                            </span>

                            <div style="clear: both;"></div>
                        </div>
                    </div>
                    <button class="normal no-cursor">
                        Оборотная сторона карты
                    </button>
                    <div class="item">
                        <div>
                            <span class="spec_after">
                                Заполните поле контакты
                            </span>
                        <textarea
                                placeholder="Введите контактную информацию (сайт, адрес торговой точки, телефон, e-mail)"
                                class="small contact_firm"
                                id="contacts_input">{{ template.contacts_field }}</textarea>

                            <div style="clear: both;"></div>
                        </div>
                        <div style="margin-top: 20px;" class="only_t3">
                            <div class="check_confirm_wrapper">
                                <input type="checkbox" id="confirm_input">
                            </div>
                            <span>Установите чекбокс, чтобы поместить на обратной стороне визитки ссылку для подтверждения участия.</span>

                            <div style="clear: both;"></div>
                        </div>
                        <div>
                            <span style="padding-top: 15px;">Заполните поле условия</span>
                            <textarea
                                    placeholder=""
                                    class="small"
                                    id="conditions_input">{{ template.rules_field }}</textarea>

                            <div style="clear: both;"></div>
                        </div>
                    </div>
                </div>
                <div class="shab_items">
                    <button class="normal no-cursor">Уведомления по
                        геопозиции
                    </button>
                    <div class="item">
                        <div>
                            <div class="logo_wrapper">
                                <div class="notifications_icon_wrapper bind-notifications-icon"></div>
                            </div>
                            <span class="lefted_h3 lefted">Добавьте иконку для уведомления</span>
                        <span class="lefted">Изображение в формате png, размер
  поля под логотип 50x50px.</span>

                            <div style="clear: both"></div>
                            <div class="load">
                                <a href="javascript:void(0);"
                                   title="Заменить изображение"
                                   class="send normal">Заменить изображение</a>
                                <input type="file"
                                       class="notifications_icon_input">

                                <div style="clear: both"></div>
                                <a href="javascript:void(0);"
                                   class="send address_search_btn delcur normal nomargin"
                                   title="Удалить текущее изображение">Удалить
                                    изображение</a>
                            </div>
                        </div>
                        <div class="address_place">
                            <div class="addresses">
                                {% for location in template.locations %}
                                    {% with loop_index = loop.index %}
                                        {% include "templates/includes/place.jinja2" %}
                                    {% endwith %}
                                {% endfor %}
                            </div>
                            <div class="address_form">
                                <div class="hidden">
                                    <span>Введите адрес</span>
                                    <input type="text"
                                           placeholder="Введите адрес"
                                           class="address_input">

                                    <div style="clear: both;"></div>
                                    <div style="text-align: right;">
                                        <a href="javascript:void(0);"
                                           title="Отправить"
                                           class="send address_search_btn">Поиск</a></div>
                                    <div class="holder"></div>
                                    <div style="clear: both;"></div>
                                </div>
                                <div class="hidden">
                                    <span>Введите текст уведомления</span>
                                    <input type="text"
                                           placeholder="Текст вашего уведомления"
                                           maxlength="20"
                                           class="address_legend_input">
                                    <span class="tips">Не более 20 символов</span>

                                    <div style="clear: both;"></div>
                                </div>
								 <div style="clear: both;"></div>
                                <div style="text-align: right;">
								<a style="float: left;"
                                        href="javascript:void(0);"
                                        title="Сохранить"
                                        class="send address_add_btn save_point">Сохранить точку</a>
								
								<a
                                        href="javascript:void(0);"
                                        title="Отправить"
                                        class="send address_add_btn add_point">Добавить
                                    еще точку</a></div>

                                <div style="clear: both;"></div>
								 <span class="tips" style="float:right; margin-top: 5px;">Не более 10 точек</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="step_form finish">
                <div class="shab_items">
                    <div class="item">
                        <div>
                            <span class="lefted" id="card_link"
                                  style="padding-left: 0; font-size: 13px; color: #606a71;">
                                Нажмите на кнопку "Сохранить", чтобы получить ссылку на карту
                                {% if template %}
                                    <a href="https://{{ site_name }}/b{{ template.first_passbook_url }}/">
                                        https://{{ site_name }}/b{{ template.first_passbook_url }}/
                                    </a>
                                {% else %}
                                    <a href=""></a>
                                {% endif %}
                            </span>
                            <button onclick="send_form(1)">Сохранить</button>
                        </div>
                    </div>
                    <button class="normal no-cursor">Отправить ссылку на
                        почту
                    </button>
                    <div class="item">
                        <div>
                            <span style="width: 280px; font-size: 13px;">Введите email, на который вы хотите отправить ссылку</span>
                            <input type="text" placeholder="почта"
                                   id="send_to_email" class="mail">

                            <div style="clear: both;"></div>
                            <div style="text-align: right; margin-right: 20px;">
                                <a href="javascript:void(0);" title="Отправить"
                                   class="send address_search_btn email">Отправить</a>
                            </div>
                            <div style="clear: both;"></div>
                        </div>
                    </div>
                    <button class="normal no-cursor">Отправить ссылку по SMS
                    </button>
                    <div class="item">
                        <div>
                            <span style="width: 280px; font-size: 13px;">Введите телефонный номер, на который нужно получить карту</span>
                            <input type="text" placeholder="Телефон"
                                   class="phone" id="send_to_phone">

                            <div style="clear: both;"></div>
                            <div style="text-align: right; margin-right: 20px;">
                                <a href="javascript:void(0);" title="Отправить"
                                   class="send address_search_btn send_phone">Отправить</a>
                            </div>
                            <div style="clear: both;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button class="step2 prev_button">Вернуться обратно</button>
            <button class="colored step2 next_button">Следующий шаг</button>
            <button class="colored step2 finish_button" onclick="send_form()">
                Сохранить шаблон
            </button>
        </div>
    </div>

    <script>

        {% if template %}
            card.card_type = "{{ template.ttype }}";
            card.template_id = "{{ template.id }}";
            {% if template.locations|length > 0 %}
                card.places = [];
            {% endif %}
            {% for location in template.locations %}
                {% if location.title %}
                    itemzap++;
                    card.places.push(
                            {
                                'title': '{{ location.title }}',
                                'lat': {{ location.lat|default(0) }},
                                'lng': {{ location.lng|default(0) }},
                                'legend': '{{ location.legend }}'
                            }
                    );
                {% endif %}
            {% endfor %}
            {% if template.locations|length > 0 %}
                card.addPlace();
            {% endif %}
            $(document).ready(function () {
                card.card_type = "{{ template.ttype }}";
                if (card.card_type == 'coupon') {
                    $('.type_2_btn').click();
                } else if (card.card_type == 'event') {
                    $('.type_3_btn').click();
                } else {
                    $('.type_1_btn').click();
                }
                card.logo = 'data:image/png;base64,'
                + '{{ template.images['logo.png']|replace("\n", "") }}';
                card.strip = 'data:image/png;base64,'
                + '{{ template.images['strip.png']|replace("\n", "") }}';
                card.notifications_icon = 'data:image/png;base64,'
                + '{{ template.images['icon.png']|replace("\n", "") }}';
                initSecondStep();
                initFirstStep();
                {#                card.applyChanges();#}
            });
        {% endif %}

        var send_form = function (draft) {
            card.applyChanges();
            $('input').change();

            var data = {
                'background_color': card.bg_color,
                'foreground_color': card.text_color,
                'label_color': card.head_color,
                'card_type': card.card_type,
                'organization_name': $('#organizationName').val(),

                'logo': card.logo,
                'strip': card.strip,
                'icon': card.notifications_icon,
                'barcode_format': card.barcode_type,

                'logo_text': card.name,
                'rules_field': card.conditions,
                'contacts_field': card.contacts,

                'expiration_date': card.date,
                'primary_field': card.discount,
                'secondary_field': card.description,

                'places': card.places,

                'confirm': card.confirm,
                '_csrf_token': '{{ csrf_token() }}'
            };

            var url = '{{ url_for('templates_new') }}';
            if (card.template_id) {
                url = url + card.template_id + '/';
            }

            if (!draft) {
                $('.finish_button').attr('disabled', 'disabled');
                sweetAlert(
                        "Сохраняем",
                        "Пожалуйста, подождите",
                        "info"
                );
                $.post(
                        url,
                        data,
                        function (res, status) {
                            $('.finish_button').removeAttr('disabled');
                            if (status == 'success' && res) {
                                document.location.href = '{{ url_for('templates') }}';
                            }
                        }
                );
            } else {
                data['draft'] = 1;
                $.post(
                        url,
                        data,
                        function (res, status) {
                            if (status == 'success' && res) {
                                window.console.log(res);
                                card.template_id = res.template_id;
                                var cl = $('#card_link');
                                var lnk = 'https://card.bepass.ru/b' + res.url;
                                cl.find('a').html(lnk);
                                cl.find('a').attr('href', lnk)
                            }
                        }
                );
            }
        };

        var send_link = function (to) {
            var url = '{{ url_for('link_send') }}';
            if (card.template_id) {
                url = url + card.template_id + '/';
            } else {
                return;
            }

            var email, sms;
            if (to == 'email') {
                email = $('#send_to_email').val();
            } else if (to == 'sms') {
                sms = $('#send_to_phone').val();
            }

            if (!email && !sms)
                return;

            $.get(
                    url,
                    {'email': email, 'phone': sms},
                    function (res) {
                        if (res['exceed'] == 1) {
                            sweetAlert(
                                    "Ошибка",
                                    "Вы привысили лимит в 500 смс сообщений",
                                    "error"
                            );
                        } else {
                            if (sms)
                            sweetAlert(
                                    "Успешно",
                                    "На указанный телефон была отправлена " +
                                    "ссылка на Вашу карту",
                                    "success"
                            );
                            else if (email)
                                sweetAlert(
                                        "Успешно",
                                        "На указанный e-mail была отправлена " +
                                        "ссылка на Вашу карту",
                                        "success"
                                );
                        }
                    }
            );
        };
    </script>
{% endblock content %}